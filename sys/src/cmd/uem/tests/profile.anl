#!/bin/rc

#DEBUG='-v 9'
DEBUG='-v 10'

# calc IP
IP=11.$treeip(1)

# /n/home/lib/profile
# TESTDIR=$home/uem_test
TESTDIR=/tmp/uem_test

GANGLOG=$TESTDIR'/gangfs-'$IP'.log'
EXECLOG=$TESTDIR'/execfs-'$IP'.log'
MPIPELOG=$TESTDIR'/mpipefs-'$IP'.log'

if(~ $cpunode '1'){
	i=`{cat /net/ipifc/clone} #`
	echo bind torus /dev/torus > /net/ipifc/$i/ctl
	echo add 10.$xyzip(1) $xyzip(2) 10.$xyzip(3) > /net/ipifc/$i/ctl
}

# fire up a cache
if(~ $cpunode '0') {
	ramcfs -a $fsaddr -n /n/cache
	bind /n/cache/n/local /n/frontend
	bind -c /n/frontend^$fshome /n/home
	bind -c /n/frontend^$plan9root /n/root
}

# bind our shit for now
bind -a /n/root /
bind -b /n/root/power/bin /bin
bind -b /n/root/rc/bin /bin
bind -a /n/root/sys /sys
# should already be running!

if(test -e '/net/cs')
	echo cs already running
if not 
	ndb/cs

@{
	rfork n

	mkdir -p $TESTDIR

	# start up the UEM stuff
	#execfs -m /n/io/proc
	rm -f $EXECLOG
	echo '***** starting execfs (on '$IP' with execcmd log on '$TESTDIR') *****'
	execfs $DEBUG -T $TESTDIR >>[2] $EXECLOG

	# FIXME: segmented names.  Will need two names for child and
	# parent.

	# if we are an ionode
	if (~ $cpunode '0'){
 		rm -f $GANGLOG $MPIPELOG
		echo '***** starting gangfs (master='$IP') *****'
		gangfs $DEBUG -n io >>[2] $GANGLOG
	}
	if (~ $cpunode '1'){
		echo '***** starting gangfs (child='$IP') *****'
		gangfs $DEBUG -p io -n $IP >>[2] $GANGLOG
	}

	#csrv
	echo '***** starting mpipefs (on '$IP') *****'
	mpipefs $DEBUG >>[2] $MPIPELOG

	# adds an extra hop but allows visibility of mpipefs
	srvfs uem /proc
}

mount -c /srv/uem /proc

echo okay squidboy?

