#!/bin/rc
# 
# Gangfs Regression
#

echo '== Gangfs Regression =='

#
# Parameters
#
O=8.
CMD=../$O

TESTDIR=.test/gangfs
#TESTDIR=/tmp/testbed

GANGLOG=$TESTDIR/gangfs.log
EXECLOG=$TESTDIR/exec2fs.log
MPIPELOG=$TESTDIR/mpipefs.log
ERRORLOG=$TESTDIR/error.log

E_MNTPATH=$TESTDIR/E

M_MNTPATH=$TESTDIR/M
#M_MNTPATH=$E_MNTPATH

G_MNTPATH=$TESTDIR/G

#
# Cleanup Previous Instances
#
fn cleanup {
	echo Cleaning up previous runs.

	rm -f $E_MNTPATH $M_MNTPATH $G_MNTPATH /tmp/testbed
	rm -rf $TESTDIR
}

fn shutdown {
	echo Shutting down previous runs.

	# FIXME: should there be multiple mpipes?
	unmount /n/mpipetest > /dev/null >[2] /dev/null
	unmount $E_MNTPATH > /dev/null >[2] /dev/null
	unmount $M_MNTPATH > /dev/null >[2] /dev/null

	rm -f /srv/mpipe
	rm -f /srv/exec2fs
	rm -f /n/mpipetest

	unmount /proc > /dev/null >[2] /dev/null
	bind '#p' /proc
}

#
# Startup mpipefs 
#
fn startup_mpipe {
	echo Starting mpipefs....

	if(~ $#* 0) {
		$CMD^mpipefs >[2] $MPIPELOG # $M_MNTPATH
	}
	if not {
		$CMD^mpipefs -v $1 >[2] $MPIPELOG # CHATTY
	}
}

#
# Startup exec2fs 
#
fn startup_exec2fs {
	echo Starting exec2fs.
	if(~ $#* 0) {
		$CMD^exec2fs -s exec2fs -E $CMD^execcmd -m $E_MNTPATH -L $TESTDIR -Z $M_MNTPATH >[2] $EXECLOG 
	}
	if not {
		$CMD^exec2fs -v $1 -s exec2fs -E $CMD^execcmd -m $E_MNTPATH -L $TESTDIR -Z $M_MNTPATH >[2] $EXECLOG  	# CHATTY
	}
}

fn startup_gangfs {
	echo Starting gangfs.
	if(~ $#* 0) {
		$CMD^gangfs -R 0 -m $G_MNTPATH -E $E_MNTPATH -N 4 >[2] $GANGLOG 
	}
	if not {
		$CMD^gangfs -v $1 -R 0 -m $G_MNTPATH -E $E_MNTPATH -N 4 >[2] $GANGLOG  	# CHATTY
	}
}

fn startup {
	mkdir -p $TESTDIR
	mkdir -p $E_MNTPATH $M_MNTPATH $G_MNTPATH 

	startup_exec2fs $1
	startup_mpipe $1
	startup_gangfs $1

	bind -bc .  /$objtype/bin
	bind -bc .. /$objtype/bin
}

#
# Setup a testdirp
#
fn testdir {
	mkdir -p $TESTDIR
}

fn myexec {
	mypid=`{cat}
	echo res 5 >>[2] $ERRORLOG
	echo exec /bin/cat $TESTDIR/test >>[2] $ERRORLOG
	cat /proc/g$mypid/stdout > $TESTDIR/test1 >>[2] $ERRORLOG
}

fn myexec2 {
	mypid=`{cat}
	echo res 5 >>[2] $ERRORLOG
	echo exec /bin/cat >>[2] $ERRORLOG
	cat $TESTDIR/test > /proc/g$mypid/stdin >>[2] $ERRORLOG
	cat /proc/g$mypid/stdout > $TESTDIR/test1 >>[2] $ERRORLOG
}

fn myexec3 {
	mypid=`{cat}
	echo enum >>[2] $ERRORLOG
	echo res 5 >>[2] $ERRORLOG
	echo exec /bin/cat >>[2] $ERRORLOG
	read -n 5 $TESTDIR/test > /proc/g$mypid/stdin >>[2] $ERRORLOG &
	cat /proc/g$mypid/stdout > $TESTDIR/test1 >>[2] $ERRORLOG
}

fn basic {
	echo -n Basic Test....

	# initialize files
	echo Hello Squidboy > $TESTDIR/test
	echo > $TESTDIR/test1

	# execute test
	myexec <>/proc/gclone >[1=0]

	# verify results (yes, I'm lazy)
	cat $TESTDIR/test > $TESTDIR/test2
	cat $TESTDIR/test >> $TESTDIR/test2
	cat $TESTDIR/test >> $TESTDIR/test2
	cat $TESTDIR/test >> $TESTDIR/test2
	cat $TESTDIR/test >> $TESTDIR/test2
	if(! cmp -s $TESTDIR/test2 $TESTDIR/test1) {
		echo FAILED!
		exit 'stdout: test failed'
	}

	echo Success!
	# cleanup
	rm -rf $TESTDIR/*
}

fn stdin {
	echo -n STDIN Test....

	# initialize files
	echo Hello Squidboy > $TESTDIR/test
	echo > $TESTDIR/test1

	# execute test
	myexec2 <>/proc/gclone >[1=0]

	# verify results (yes, I'm lazy)
	cat $TESTDIR/test > $TESTDIR/test2
	cat $TESTDIR/test >> $TESTDIR/test2
	cat $TESTDIR/test >> $TESTDIR/test2
	cat $TESTDIR/test >> $TESTDIR/test2
	cat $TESTDIR/test >> $TESTDIR/test2
	if(! cmp -s $TESTDIR/test2 $TESTDIR/test1) {
		echo FAILED!
		exit 'stdout: test failed'
	}

	echo Success!
	# cleanup
	rm -rf $TESTDIR/*
}

fn enum {
	echo -n Enumerated STDIN Test....

	# initialize files
	echo one > $TESTDIR/test
	echo two >> $TESTDIR/test
	echo three >> $TESTDIR/test
	echo four >> $TESTDIR/test
	echo five >> $TESTDIR/test

	echo > $TESTDIR/test1

	# execute test
	myexec3 <>/proc/gclone >[1=0]

	# verify results 
	if(! cmp -s $TESTDIR/test $TESTDIR/test1) {
		echo FAILED!
		exit 'stdout: test failed'
	}

	echo Success!
	# cleanup
	rm -rf $TESTDIR/*
}

# Setup
rfork

cleanup
startup $1
testdir

# Tests
basic
stdin
enum

# Cleanup
rm -rf $TESTDIR
cleanup
