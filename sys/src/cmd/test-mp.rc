#!/bin/rc
# 
# Multipipe Regression
#

# TODO:
# * long message
# * enumerated pipe
# * broadcast pipe
# * broadcast splice from

#
# Parameters
#
MPIPELOG=./mpipe.log
TESTDIR=.test

#
# Cleanup Previous Instances
#
fn cleanup {
	echo Cleaning up previous runs...
	unmount /n/test > /dev/null >[2] /dev/null
	rm -f /srv/mpipe
	kill mpipefs | rc
}

#
# Startup mpipefs with debug
#
fn startup {
	echo Starting mpipefs....
	./mpipefs >[2] $MPIPELOG 
}

#
# Simple Pipe Test
#

fn simplepipe {
	echo -n Testing simple pipe operation...

	# initialize files
	mkdir -p $TESTDIR
	echo Hello Squidboy > $TESTDIR/test
	echo > $TESTDIR/test1

	mount /srv/mpipe /n/test
	cat $TESTDIR/test > /n/test/data &
	cat /n/test/data > $TESTDIR/test1

	# verify results
	if(! cmp -s $TESTDIR/test $TESTDIR/test1) {
		echo FAILED!
		exit 'simplepipe: test failed'
	}

	echo Success!
	# cleanup
	rm -rf $TESTDIR
}

#
# splicefrom test
#
fn splicefrom {
	echo -n Testing splicefrom...

	# initialize test files
	mkdir -p $TESTDIR
	echo Hello Squidboy > $TESTDIR/test
	echo > $TESTDIR/test1

	# accomplish the test
	mount /srv/mpipe /n/test
	cat /n/test/data > $TESTDIR/test1 &
	mp-writer -i $TESTDIR/test /n/test/data
	
	unmount /n/test
	
	# verify results
	if(! cmp -s $TESTDIR/test $TESTDIR/test1) {
		echo FAILED: test1 not equal to test
		exit 'splicefrom: test1 failed'
	}
	
	echo Success!

	# cleanup
	rm -rf $TESTDIR
}

#
# spliceto test
#
fn spliceto {
	echo -n Testing spliceto...

	# initialize test files
	mkdir -p $TESTDIR
	echo Hello Squidboy > $TESTDIR/test
	echo > $TESTDIR/test1

	# accomplish the test
	mount /srv/mpipe /n/test
	mp-writer -o $TESTDIR/test1 /n/test/data
	cat $TESTDIR/test > /n/test/data
	unmount /n/test
	
	# verify results
	if(! cmp -s $TESTDIR/test $TESTDIR/test1) {
		echo FAILED: test1 not equal to test
		exit 'spliceto: test1 failed'
	}
	
	echo Success!

	# cleanup
	rm -rf $TESTDIR
}


#
# Broadcast spliceto test
#
fn splicetobcast {
	echo -n Testing spliceto with broadcast...

	# initialize test files
	mkdir -p $TESTDIR
	echo Hello Squidboy > $TESTDIR/test
	echo > $TESTDIR/test1
	echo > $TESTDIR/test2

	# accomplish the test
	mount /srv/mpipe /n/test -b
	mp-writer -o $TESTDIR/test1 /n/test/data
	mp-writer -o $TESTDIR/test2 /n/test/data
	cat $TESTDIR/test > /n/test/data
	unmount /n/test
	
	# verify results
	if(! cmp -s $TESTDIR/test $TESTDIR/test1) {
		echo FAILED: test1 not equal to test
		exit 'splicetobcast: test1 failed'
	}
	
	if(! cmp -s $TESTDIR/test $TESTDIR/test2) {
		echo FAILED: test2 not equal to test
		exit 'splicetobcast: test2 failed'
	}

	echo Success!

	# cleanup
	rm -rf $TESTDIR
}

# Setup
cleanup
startup

# Tests
simplepipe
splicefrom
spliceto
splicetobcast

# Cleanup
cleanup
